name: Backend Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout Source Code
        uses: actions/checkout@v3

      # 2. ìžë°” ê°œë°œí™˜ê²½(JDK) ì„¸íŒ…
      # (Java 24 ì‚¬ìš© ì¤‘. í˜¹ì‹œ ë¹Œë“œ ì—ëŸ¬ ë‚˜ë©´ '21'ì´ë‚˜ '17'ë¡œ ë‚®ì¶°ë³´ì„¸ìš”)
      - name: Set up JDK 24
        uses: actions/setup-java@v3
        with:
          java-version: '24'
          distribution: 'temurin'

      # 3. Gradle ê¶Œí•œ ë¶€ì—¬ ë° ë¹Œë“œ
      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      # -----------------------------------------------------------------------
      # 4. [ìˆ˜ì •ë¨] ì„œë²„ë¡œ jar íŒŒì¼ ì „ì†¡ (Manual SCP ë°©ì‹)
      # ê¸°ì¡´ í”ŒëŸ¬ê·¸ì¸ì´ ëŒ€ìš©ëŸ‰ íŒŒì¼ ì „ì†¡ ì‹œ ë©ˆì¶”ëŠ” ë²„ê·¸ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´
      # ë¦¬ëˆ…ìŠ¤ ê¸°ë³¸ ëª…ë ¹ì–´(scp)ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì—¬ ì•ˆì •ì ìœ¼ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
      # -----------------------------------------------------------------------
      - name: Copy Jar to Server (Manual SCP)
        run: |
          # 1) sshpass ì„¤ì¹˜ (ë¹„ë°€ë²ˆí˜¸ ìž…ë ¥ì„ ë„ì™€ì£¼ëŠ” ë„êµ¬)
          sudo apt-get update
          sudo apt-get install -y sshpass

          # 2) íŒŒì¼ ì „ì†¡ ì‹¤í–‰
          # -o StrictHostKeyChecking=no : ì²˜ìŒ ì ‘ì†í•  ë•Œ 'ê³„ì† ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' ì§ˆë¬¸ ë¬´ì‹œ
          # build/libs/*.jar : ë¹Œë“œëœ ê²°ê³¼ë¬¼
          sshpass -p "${{ secrets.PASSWORD }}" scp -o StrictHostKeyChecking=no build/libs/*.jar ${{ secrets.USERNAME }}@${{ secrets.HOST }}:/home/ubuntu/app/

      # 5. ì„œë²„ ì ‘ì†í•´ì„œ ìž¬ì‹œìž‘ (SSH)
      - name: Restart Spring Boot
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            cd /home/ubuntu/app

            # 1) ê¸°ì¡´ ì„œë²„ ì¢…ë£Œ
            echo "ðŸ›‘ ê¸°ì¡´ ì„œë²„ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤..."
            fuser -k 8080/tcp || true
            sleep 5

            # 2) ìƒˆ ì„œë²„ ì‹¤í–‰
            echo "ðŸš€ ìƒˆ ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
            
            # [ì¤‘ìš” ì˜µì…˜ ì„¤ëª…]
            # -Xmx512m : ëž¨ì´ 1GBì¸ Micro ì„œë²„ì—ì„œ ìžë°”ê°€ í˜¼ìž ë‹¤ ì“°ë‹¤ê°€ ì£½ëŠ” ê²ƒì„ ë°©ì§€ (ìµœëŒ€ 512MBë§Œ ì‚¬ìš©)
            # -Djava.security.egd... : ë¦¬ëˆ…ìŠ¤ ì„œë²„ì—ì„œ ìŠ¤í”„ë§ ë¶€íŒ… ì†ë„ë¥¼ ë¹ ë¥´ê²Œ í•˜ëŠ” ì˜µì…˜
            # nohup ... & : í„°ë¯¸ë„ì„ êº¼ë„ ì„œë²„ê°€ ê³„ì† ëŒì•„ê°€ê²Œ í•˜ëŠ” ëª…ë ¹ì–´
            nohup java -Xmx512m -Djava.security.egd=file:/dev/./urandom -jar *.jar --spring.profiles.active=prod > app.log 2>&1 &