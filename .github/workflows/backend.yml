name: Backend Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout Source Code
        uses: actions/checkout@v3

      # 2. ìžë°” ê°œë°œí™˜ê²½(JDK) ì„¸íŒ…
      # (ì‚¬ìš© ì¤‘ì¸ Java 24 ë²„ì „ì— ë§žì·„ìŠµë‹ˆë‹¤. í˜¹ì‹œ ì—ëŸ¬ ë‚˜ë©´ '21'ë¡œ ë³€ê²½í•´ë³´ì„¸ìš”)
      - name: Set up JDK 24
        uses: actions/setup-java@v3
        with:
          java-version: '24'
          distribution: 'temurin'

      # 3. Gradle ê¶Œí•œ ë¶€ì—¬ ë° ë¹Œë“œ
      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      # 4. ì„œë²„ë¡œ jar íŒŒì¼ ì „ì†¡ (SCP)
      - name: Copy Jar to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          # ë¹Œë“œëœ jar íŒŒì¼ ê²½ë¡œ
          source: "build/libs/*.jar"
          target: "/home/ubuntu/app"
          strip_components: 2

      # 5. ì„œë²„ ì ‘ì†í•´ì„œ ìž¬ì‹œìž‘ (SSH)
      - name: Restart Spring Boot
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            cd /home/ubuntu/app

            # 1. ê¸°ì¡´ ì„œë²„ ì¢…ë£Œ
            echo "ðŸ›‘ ê¸°ì¡´ ì„œë²„ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤..."
            fuser -k 8080/tcp || true
            sleep 5

            # 2. ìƒˆ ì„œë²„ ì‹¤í–‰ (ë©”ëª¨ë¦¬ ì œí•œ ì˜µì…˜ ì¶”ê°€ë¨!)
            echo "ðŸš€ ìƒˆ ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
            
            # [ìˆ˜ì •ë¨]
            # -Xmx512m : ìµœëŒ€ ë©”ëª¨ë¦¬ë¥¼ 512MBë¡œ ì œí•œ (Micro ì„œë²„ íŠ•ê¹€ ë°©ì§€ í•„ìˆ˜ ì˜µì…˜)
            # -Djava.security.egd : ë‚œìˆ˜ ìƒì„± ì†ë„ í–¥ìƒ (ë¶€íŒ… ì§€ì—° ë°©ì§€)
            nohup java -Xmx512m -Djava.security.egd=file:/dev/./urandom -jar *.jar --spring.profiles.active=prod > app.log 2>&1 &