name: Backend Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 코드 가져오기
      - name: Checkout Source Code
        uses: actions/checkout@v3

      # 2. 자바 개발환경(JDK) 세팅
      # (사용 중인 Java 24 버전에 맞췄습니다. 혹시 에러 나면 '21'로 변경해보세요)
      - name: Set up JDK 24
        uses: actions/setup-java@v3
        with:
          java-version: '24'
          distribution: 'temurin'

      # 3. Gradle 권한 부여 및 빌드
      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      # 4. 서버로 jar 파일 전송 (SCP)
      - name: Copy Jar to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          # 빌드된 jar 파일 경로 (Gradle 기본 경로)
          source: "build/libs/*.jar"
          target: "/home/ubuntu/app"
          # build/libs 폴더 껍데기 2개를 벗기고 jar 알맹이만 전송
          strip_components: 2

      # 5. 서버 접속해서 재시작 (SSH)
      - name: Restart Spring Boot
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            # 1) 작업 폴더로 이동
            cd /home/ubuntu/app

            # 2) 8080 포트 쓰고 있는 기존 서버 강제 종료
            # (fuser가 설치되어 있는 것을 확인했으므로 바로 사용합니다)
            fuser -k 8080/tcp || true

            # 3) 완전히 꺼질 때까지 5초 대기
            sleep 5

            # 4) 새 Jar 파일 실행
            # (알려주신 prod 프로파일 적용 + nohup으로 백그라운드 실행)
            # *.jar를 쓰면 파일명 버전을 매번 안 바꿔도 돼서 편리합니다.
            nohup java -jar *.jar --spring.profiles.active=prod > app.log 2>&1 &