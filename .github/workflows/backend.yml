name: Backend Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name: Set up JDK 24
        uses: actions/setup-java@v3
        with:
          java-version: '24'
          distribution: 'temurin'

      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      # -----------------------------------------------------------------------
      # [1ë‹¨ê³„] ê¸°ì¡´ ì„œë²„ ë¨¼ì € ë„ê¸° (ëž¨ í™•ë³´)
      # íŒŒì¼ ì˜¬ë¦¬ê¸° ì „ì— ë¬´ê±°ìš´ ìžë°”ë¥¼ ë¨¼ì € êº¼ì•¼ Micro ì„œë²„ê°€ ë²„íŒë‹ˆë‹¤.
      # -----------------------------------------------------------------------
      - name: Stop Current Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            echo "ðŸ›‘ íŒŒì¼ ì „ì†¡ ì „, ë©”ëª¨ë¦¬ í™•ë³´ë¥¼ ìœ„í•´ ì„œë²„ë¥¼ ë¨¼ì € ì¢…ë£Œí•©ë‹ˆë‹¤..."
            fuser -k 8080/tcp || true
            sleep 5 # ì™„ì „ížˆ ì£½ì„ ë•Œê¹Œì§€ ëŒ€ê¸°

      # -----------------------------------------------------------------------
      # [2ë‹¨ê³„] ì„œë²„ë¡œ jar íŒŒì¼ ì „ì†¡ (ì´ì œ ëž¨ì´ ë„ë„í•´ì„œ ì•ˆ ëŠê¹ë‹ˆë‹¤!)
      # -----------------------------------------------------------------------
      - name: Copy Jar to Server
        env:
          SSHPASS: ${{ secrets.PASSWORD }}
        run: |
          echo "ðŸ“‚ ë¹Œë“œëœ íŒŒì¼ í™•ì¸:"
          ls -lh build/libs/*.jar

          sudo apt-get update
          sudo apt-get install -y sshpass

          echo "ðŸš€ íŒŒì¼ ì „ì†¡ ì‹œìž‘..."
          # ì„œë²„ê°€ êº¼ì ¸ ìžˆì–´ì„œ ë©”ëª¨ë¦¬ê°€ ì¶©ë¶„í•˜ë¯€ë¡œ ì „ì†¡ì´ ì›í™œí•  ê²ë‹ˆë‹¤.
          sshpass -e scp -v -o StrictHostKeyChecking=no build/libs/*.jar ${{ secrets.USERNAME }}@${{ secrets.HOST }}:/home/ubuntu/app/

      # -----------------------------------------------------------------------
      # [3ë‹¨ê³„] ìƒˆ ì„œë²„ ë‹¤ì‹œ ì¼œê¸°
      # -----------------------------------------------------------------------
      - name: Start New Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            cd /home/ubuntu/app
            
            echo "ðŸš€ ìƒˆ ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
            # Swap ë©”ëª¨ë¦¬ ì„¤ì •ì´ ì—†ì–´ë„ -Xmx512m ë•ë¶„ì— ì•ˆì „í•˜ê²Œ ì¼œì§ˆ ê²ë‹ˆë‹¤.
            nohup java -Xmx512m -Djava.security.egd=file:/dev/./urandom -jar *.jar --spring.profiles.active=prod > app.log 2>&1 &